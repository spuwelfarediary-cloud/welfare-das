<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Automation System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            serverTimestamp, 
            onSnapshot, 
            query, 
            orderBy, 
            deleteDoc, 
            doc,
            getDocs,
            updateDoc,
            getDoc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCpaMthWl0eQwYXN-wt09fv_OqS4iUVxLA",
            authDomain: "welfare-das.firebaseapp.com",
            projectId: "welfare-das",
            storageBucket: "welfare-das.firebasestorage.app",
            messagingSenderId: "783240912416",
            appId: "1:783240912416:web:86c8b859e1b7162d0aa645",
            measurementId: "G-FGRCLWVY6B"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.firebaseModules = {
            db,
            collection,
            addDoc,
            serverTimestamp,
            onSnapshot,
            query,
            orderBy,
            deleteDoc,
            doc,
            getDocs,
            updateDoc,
            getDoc,
            setDoc
        };
        console.log("‚úÖ Firebase initialized successfully!");
    </script>
    
    <!-- Docx Libraries -->
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.47.0/docxtemplater.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body { background-color: #e9ecef; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 1400px; margin: 30px auto; }
        .form-section, .dashboard-section { 
            background-color: #fff; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            margin-bottom: 30px; 
        }
        .calculated-field { 
            font-weight: bold; 
            color: #007bff; 
            background-color: #f0f8ff; 
            border-radius: 5px; 
            padding: 8px; 
        }
        .loading { display: none; }
        .spinner-border { width: 1rem; height: 1rem; }
        
        /* Dashboard Styles */
        .date-group { 
            border: 1px solid #dee2e6; 
            margin-top: 20px; 
            padding: 20px; 
            border-radius: 10px; 
            background-color: #fff; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .date-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px; 
            border-radius: 8px; 
            margin-bottom: 15px;
            color: white;
        }
        .date-header h5 { 
            margin: 0; 
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .applications-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .application-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        .application-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stats-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        .btn-group-custom {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-group-custom .btn {
            flex: 1;
            min-width: 120px;
        }
        .template-alert {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="text-center text-primary mb-4">‚úÖ Document Automation System</h1>
        
        <!-- Template Status -->
        <div id="templateAlert" class="alert alert-info template-alert">
            <i class="fas fa-sync fa-spin"></i> Checking template file...
        </div>
        
        <!-- Statistics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalApplications">0</div>
                    <div class="stats-label">Total Applications</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="stats-number" id="todayApplications">0</div>
                    <div class="stats-label">Today's Applications</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="stats-number" id="totalAmount">0</div>
                    <div class="stats-label">Total Amount (PKR)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="stats-number" id="masterCount">0</div>
                    <div class="stats-label">In Master File</div>
                </div>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form" type="button">
                    <i class="fas fa-plus-circle"></i> New Application
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button">
                    <i class="fas fa-chart-bar"></i> Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button">
                    <i class="fas fa-file-word"></i> Reports
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="template-tab" data-bs-toggle="tab" data-bs-target="#template" type="button">
                    <i class="fas fa-cog"></i> Template
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="myTabContent">
            <!-- Form Tab -->
            <div class="tab-pane fade show active" id="form" role="tabpanel">
                <div class="form-section">
                    <h3 class="mb-4 text-success">üìù New Application Entry</h3>
                    <form id="advanceForm" oninput="updateCalculations()">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="applicantName" class="form-label">Applicant Name</label>
                                <input type="text" class="form-control" id="applicantName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="rank" class="form-label">Rank / Designation</label>
                                <input type="text" class="form-control" id="rank" required>
                            </div>
                            <div class="col-md-4">
                                <label for="beltNo" class="form-label">Belt No</label>
                                <input type="text" class="form-control" id="beltNo" required>
                            </div>
                            <div class="col-md-4">
                                <label for="cnic" class="form-label">CNIC Number</label>
                                <input type="text" class="form-control" id="cnic" maxlength="15" required onkeyup="validateCNIC(this)">
                            </div>
                            <div class="col-md-4">
                                <label for="gpFundNo" class="form-label">GP Fund Account No</label>
                                <input type="text" class="form-control" id="gpFundNo" required>
                            </div>
                        </div>
                        
                        <hr class="my-4">

                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="totalBalance" class="form-label">Total GP Balance (PKR)</label>
                                <input type="number" class="form-control" id="totalBalance" min="1" step="1" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Withdrawal Amount (PKR)</label>
                                <div id="advanceAmountDisplay" class="form-control calculated-field">0</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Installments (Months)</label>
                                <div id="installmentsDisplay" class="form-control calculated-field">0</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Monthly Installment (PKR)</label>
                                <div id="monthlyInstallment" class="form-control calculated-field">0</div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Withdrawal Amount (Words)</label>
                                <div id="advanceAmountWords" class="form-control calculated-field text-danger">Zero Only</div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="advanceAmount" value="0"> 
                        <input type="hidden" id="installments" value="0">
                        <input type="hidden" id="monthlyInstallmentValue" value="0">

                        <div class="d-grid gap-2 mt-4">
                            <button type="button" class="btn btn-success btn-lg" id="submitBtn" onclick="saveToFirestore()">
                                <span id="submitText">
                                    <i class="fas fa-save"></i> Submit Data to Firestore
                                </span>
                                <span class="loading" id="submitLoading">
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    Saving...
                                </span>
                            </button>
                            
                            <button type="button" class="btn btn-primary btn-lg mt-2" id="downloadBtn" onclick="generateDocumentWithTemplate()" disabled>
                                <span id="downloadText">
                                    <i class="fas fa-download"></i> Download Single DOCX
                                </span>
                                <span class="loading" id="downloadLoading">
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    Generating...
                                </span>
                            </button>
                        </div>
                        
                    </form>
                </div>
            </div>
            
            <!-- Dashboard Tab -->
            <div class="tab-pane fade" id="dashboard" role="tabpanel">
                <div class="dashboard-section">
                    <h3 class="mb-4 text-secondary">
                        <i class="fas fa-chart-bar"></i> Applications Dashboard
                    </h3>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Applications are grouped by date. Click on date headers to expand/collapse.
                    </div>
                    
                    <div id="applicationsDashboard">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading applications...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reports Tab -->
            <div class="tab-pane fade" id="reports" role="tabpanel">
                <div class="dashboard-section">
                    <h3 class="mb-4 text-primary">
                        <i class="fas fa-file-word"></i> Reports & Export
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-calendar-day"></i> Daily Reports</h5>
                                </div>
                                <div class="card-body">
                                    <p>Generate combined DOCX file for specific date</p>
                                    <div class="input-group mb-3">
                                        <input type="date" class="form-control" id="reportDate" value="">
                                        <button class="btn btn-success" onclick="generateDailyReport()">
                                            <i class="fas fa-download"></i> Generate
                                        </button>
                                    </div>
                                    <button class="btn btn-outline-primary w-100 mb-2" onclick="generateTodayReport()">
                                        <i class="fas fa-calendar-check"></i> Today's Report
                                    </button>
                                    <button class="btn btn-outline-secondary w-100" onclick="generateYesterdayReport()">
                                        <i class="fas fa-history"></i> Yesterday's Report
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-database"></i> Master Document</h5>
                                </div>
                                <div class="card-body">
                                    <p>Complete master document with all applications</p>
                                    <button class="btn btn-success w-100 mb-2" onclick="generateMasterDocx()">
                                        <i class="fas fa-file-download"></i> Download Master DOCX
                                    </button>
                                    <button class="btn btn-outline-success w-100 mb-2" onclick="updateMasterDocument()">
                                        <i class="fas fa-sync"></i> Update Master Document
                                    </button>
                                    <div class="mt-3">
                                        <small class="text-muted">Master file contains: <span id="masterAppsCount">0</span> applications</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-cogs"></i> Advanced Export</h5>
                        </div>
                        <div class="card-body">
                            <div class="btn-group-custom">
                                <button class="btn btn-outline-info" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i> Export to Excel
                                </button>
                                <button class="btn btn-outline-warning" onclick="exportAllToDocx()">
                                    <i class="fas fa-file-word"></i> Export All DOCX
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearLocalData()">
                                    <i class="fas fa-trash"></i> Clear Local Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Template Tab -->
            <div class="tab-pane fade" id="template" role="tabpanel">
                <div class="dashboard-section">
                    <h3 class="mb-4 text-info">
                        <i class="fas fa-cog"></i> Template Management
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="fas fa-file-word"></i> Current Template</h5>
                                </div>
                                <div class="card-body">
                                    <div id="templateStatus">
                                        <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                                        Checking template...
                                    </div>
                                    
                                    <div class="mt-3">
                                        <button class="btn btn-outline-primary w-100 mb-2" onclick="downloadCleanTemplate()">
                                            <i class="fas fa-download"></i> Download Clean Template
                                        </button>
                                        <button class="btn btn-outline-warning w-100" onclick="testTemplate()">
                                            <i class="fas fa-test"></i> Test Current Template
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="mb-0"><i class="fas fa-question-circle"></i> Template Instructions</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Your template should have:</strong></p>
                                    <ol class="small">
                                        <li><code>{{AdvanceAmount}}</code> - Withdrawal Amount (Numbers)</li>
                                        <li><code>{{AmountWords}}</code> - Amount in Words</li>
                                        <li><code>{{ApplicantName}}</code> - Applicant Name</li>
                                        <li><code>{{Rank}}</code> - Rank/Designation</li>
                                        <li><code>{{BeltNo}}</code> - Belt Number</li>
                                        <li><code>{{AccountNo}}</code> - GP Fund Account No</li>
                                        <li><code>{{CNIC}}</code> - CNIC Number</li>
                                        <li><code>{{Percentage}}</code> - Percentage</li>
                                        <li><code>{{TotalBalance}}</code> - Total Balance</li>
                                        <li><code>{{MonthlyInstallment}}</code> - Monthly Installment</li>
                                        <li><code>{{Installments}}</code> - Number of Installments</li>
                                    </ol>
                                    <p class="mt-3 text-danger small">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>Important:</strong> Remove all XML tags like <code>{.underline}</code> from your template
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script>
        // =========================================================
        // 1. GLOBAL VARIABLES & CONSTANTS
        // =========================================================
        const CONSTANTS = {
            MIN_INSTALLMENTS: 28,
            MAX_INSTALLMENTS: 36,
            MIN_PERCENTAGE: 0.75,
            MAX_PERCENTAGE: 0.80
        };

        let currentFormData = null;
        let allApplications = [];
        let groupedApplications = {};
        let masterApplications = [];
        let unsubscribe = null;
        let templateAvailable = false;

        // =========================================================
        // 2. CORE CALCULATION FUNCTIONS
        // =========================================================
        function numberToWordsPakistani(n) {
            if (n === 0) return "Zero Only";
            if (n < 0) return "Negative " + numberToWordsPakistani(-n);
            
            const ones = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
            const teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
            const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
            
            function convertHundreds(num) {
                let result = "";
                if (num >= 100) {
                    result += ones[Math.floor(num / 100)] + " Hundred ";
                    num %= 100;
                }
                if (num >= 20) {
                    result += tens[Math.floor(num / 10)] + " ";
                    num %= 10;
                } else if (num >= 10) {
                    result += teens[num - 10] + " ";
                    num = 0;
                }
                if (num > 0) {
                    result += ones[num] + " ";
                }
                return result.trim();
            }
            
            let result = "";
            let num = Math.floor(n);
            
            if (num >= 10000000) {
                result += convertHundreds(Math.floor(num / 10000000)) + " Crore ";
                num %= 10000000;
            }
            
            if (num >= 100000) {
                result += convertHundreds(Math.floor(num / 100000)) + " Lakh ";
                num %= 100000;
            }
            
            if (num >= 1000) {
                result += convertHundreds(Math.floor(num / 1000)) + " Thousand ";
                num %= 1000;
            }
            
            result += convertHundreds(num);
            
            return result.trim() + " Only";
        }

        function calculateOptimalAdvance(balance) {
            if (balance <= 0) return { advance: 0, installments: 0, monthly: 0, percentage: 0 };

            const minAllowed = Math.ceil(balance * CONSTANTS.MIN_PERCENTAGE);
            const maxAllowed = Math.floor(balance * CONSTANTS.MAX_PERCENTAGE);

            for (let withdrawal = maxAllowed; withdrawal >= minAllowed; withdrawal--) {
                for (let months = CONSTANTS.MAX_INSTALLMENTS; months >= CONSTANTS.MIN_INSTALLMENTS; months--) {
                    const monthly = withdrawal / months;
                    if (Number.isInteger(monthly) && monthly >= 1) {
                        return {
                            advance: withdrawal,
                            installments: months,
                            monthly: monthly,
                            percentage: ((withdrawal / balance) * 100).toFixed(2)
                        };
                    }
                }
            }
            return { advance: 0, installments: 0, monthly: 0, percentage: 0 };
        }

        function updateCalculations() {
            const balance = parseInt(document.getElementById('totalBalance').value) || 0;
            const result = calculateOptimalAdvance(balance);
            
            document.getElementById('advanceAmountDisplay').textContent = result.advance.toLocaleString('en-PK');
            document.getElementById('installmentsDisplay').textContent = result.installments;
            document.getElementById('monthlyInstallment').textContent = result.monthly.toLocaleString('en-PK');
            document.getElementById('advanceAmountWords').textContent = numberToWordsPakistani(result.advance);

            document.getElementById('advanceAmount').value = result.advance;
            document.getElementById('installments').value = result.installments;
            document.getElementById('monthlyInstallmentValue').value = result.monthly;
            
            currentFormData = {
                applicantName: document.getElementById('applicantName').value || '',
                rank: document.getElementById('rank').value || '',
                beltNo: document.getElementById('beltNo').value || '',
                cnic: document.getElementById('cnic').value || '',
                gpFundNo: document.getElementById('gpFundNo').value || '',
                totalBalance: balance,
                advanceAmount: result.advance,
                installments: result.installments,
                monthlyInstallment: result.monthly,
                amountWords: numberToWordsPakistani(result.advance),
                percentage: result.percentage
            };
        }

        function validateCNIC(input) {
            const cnicPattern = /^\d{5}-\d{7}-\d{1}$/;
            let value = input.value.replace(/[^\d]/g, '');
            
            if (value.length > 0) {
                if (value.length <= 5) {
                    input.value = value;
                } else if (value.length <= 12) {
                    input.value = value.slice(0, 5) + '-' + value.slice(5);
                } else {
                    input.value = value.slice(0, 5) + '-' + value.slice(5, 12) + '-' + value.slice(12, 13);
                }
            }
            
            input.classList.toggle('is-invalid', !cnicPattern.test(input.value) && input.value.length > 0);
        }

        // =========================================================
        // 3. TEMPLATE MANAGEMENT
        // =========================================================
        async function checkTemplateFile() {
            try {
                const response = await fetch('template.docx?t=' + new Date().getTime());
                if (response.ok) {
                    const content = await response.arrayBuffer();
                    
                    // Try to validate template
                    try {
                        const zip = new PizZip(content);
                        const doc = new docxtemplater(zip);
                        templateAvailable = true;
                        
                        document.getElementById('templateAlert').className = 'alert alert-success template-alert';
                        document.getElementById('templateAlert').innerHTML = 
                            '<i class="fas fa-check-circle"></i> <strong>Template Status:</strong> template.docx found and ready!';
                        
                        document.getElementById('templateStatus').innerHTML = 
                            '<div class="alert alert-success mb-0"><i class="fas fa-check-circle"></i> Template is valid and ready to use</div>';
                        
                    } catch (templateError) {
                        templateAvailable = false;
                        document.getElementById('templateAlert').className = 'alert alert-warning template-alert';
                        document.getElementById('templateAlert').innerHTML = 
                            '<i class="fas fa-exclamation-triangle"></i> <strong>Template Status:</strong> template.docx has formatting issues. Download clean template from Template tab.';
                        
                        document.getElementById('templateStatus').innerHTML = 
                            '<div class="alert alert-warning mb-0"><i class="fas fa-exclamation-triangle"></i> Template has formatting issues. Please download clean template.</div>';
                    }
                    
                } else {
                    templateAvailable = false;
                    document.getElementById('templateAlert').className = 'alert alert-danger template-alert';
                    document.getElementById('templateAlert').innerHTML = 
                        '<i class="fas fa-times-circle"></i> <strong>Template Status:</strong> template.docx not found. Download clean template from Template tab.';
                    
                    document.getElementById('templateStatus').innerHTML = 
                        '<div class="alert alert-danger mb-0"><i class="fas fa-times-circle"></i> Template file not found. Please download clean template.</div>';
                }
            } catch (error) {
                templateAvailable = false;
                document.getElementById('templateAlert').className = 'alert alert-danger template-alert';
                document.getElementById('templateAlert').innerHTML = 
                    '<i class="fas fa-times-circle"></i> <strong>Template Status:</strong> Error checking template file.';
            }
        }

        function downloadCleanTemplate() {
            // Your template content without XML tags
            const cleanTemplate = `> Government of the Punjab
> Police Department

No. /Acct/SPU Dated / / 2025

**ORDER:**

In exercise of the powers vested in me under Rule.1.14(1)(a)(iv)(d)(i)
of the Punjab Provident Fund Rules, 1978, sanction is hereby accorded to
the grant of refundable advance of Rs.{{AdvanceAmount}}/- (Rupees
{{AmountWords}} Only) in respect of Mr. {{ApplicantName}} {{Rank}} {{BeltNo}} of
Special Protection Unit (SPU) Punjab Lahore from his G.P. Fund Account
as mentioned in his G.P. Fund/Personal Account No. {{AccountNo}} and CNIC
No. {{CNIC}} For construction/repairing of his house. The amount is
approximately equal to {{Percentage}}% of the balance at his credit in his
G.P. Fund account Rs. {{TotalBalance}}/-.

2. The recovery of the advance shall be made at the rate of Rs.
{{MonthlyInstallment}}/- in {{Installments}} equal installments from the pay
of subscriber which will commence from the pay of the month following
the month in which the advance is drawn.

3. It is certified that there is sufficient balance at his credit to
meet the advance. The amount of advance is debatable under head
G-Liabilities-G06-Trust Account Fund-G061-Provident Fund-G06103-General
Provident Fund (Civil)-LO5635.

> **Additional Director Admin/DDO,**
>
> for Director/Deputy Inspector General of Police,
>
> Special Protection Unit,
>
> Punjab, Lahore.

No. /Acct/SPU Dated /2025

A copy is forwarded for information and necessary action to the:-

I. Accountant General, Punjab, Lahore.

> **Additional Director Admin/DDO,**
>
> for Director/Deputy Inspector General of Police,
>
> Special Protection Unit,
>
> Punjab, Lahore`;
            
            // Download as text file
            const blob = new Blob([cleanTemplate], { type: 'text/plain' });
            saveAs(blob, 'clean_template.txt');
            
            alert('üìù Clean template downloaded as clean_template.txt\n\nInstructions:\n1. Open Microsoft Word\n2. Copy this content\n3. Format as needed (bold, underline, etc.)\n4. Save as "template.docx"\n5. Place in same folder as this webpage\n6. Refresh this page');
        }

        async function testTemplate() {
            try {
                const response = await fetch('template.docx?t=' + new Date().getTime());
                const content = await response.arrayBuffer();
                const zip = new PizZip(content);
                const doc = new docxtemplater(zip);
                
                // Test with dummy data
                const testData = {
                    AdvanceAmount: "75,000",
                    AmountWords: "Seventy Five Thousand Only",
                    ApplicantName: "Test Applicant",
                    Rank: "Constable",
                    BeltNo: "12345",
                    AccountNo: "GPF-001",
                    CNIC: "12345-1234567-1",
                    Percentage: "75.00",
                    TotalBalance: "100,000",
                    MonthlyInstallment: "2,678",
                    Installments: "28"
                };
                
                doc.setData(testData);
                doc.render();
                
                alert('‚úÖ Template test successful! Your template is working correctly.');
                
            } catch (error) {
                alert('‚ùå Template test failed: ' + error.message + '\n\nPlease download clean template from Template tab.');
            }
        }

        // =========================================================
        // 4. DOCUMENT GENERATION (WITH FALLBACK)
        // =========================================================
        async function generateDocumentWithTemplate() {
            if (!currentFormData || !currentFormData.applicantName) {
                alert("Please fill the form first.");
                return;
            }

            document.getElementById('downloadText').style.display = 'none';
            document.getElementById('downloadLoading').style.display = 'inline';
            document.getElementById('downloadBtn').disabled = true;

            try {
                if (templateAvailable) {
                    await generateWithTemplate();
                } else {
                    await generateSimpleDocument();
                }
            } catch (error) {
                console.error("DOCX Generation Error:", error);
                await generateSimpleDocument();
            } finally {
                document.getElementById('downloadText').style.display = 'inline';
                document.getElementById('downloadLoading').style.display = 'none';
                document.getElementById('downloadBtn').disabled = false;
            }
        }

        async function generateWithTemplate() {
            try {
                const response = await fetch('template.docx?t=' + new Date().getTime());
                const content = await response.arrayBuffer();
                const zip = new PizZip(content);
                const doc = new docxtemplater(zip, { 
                    paragraphLoop: true, 
                    linebreaks: true 
                });

                const exportData = {
                    AdvanceAmount: currentFormData.advanceAmount.toLocaleString('en-PK'),
                    AmountWords: currentFormData.amountWords,
                    ApplicantName: currentFormData.applicantName,
                    Rank: currentFormData.rank,
                    BeltNo: currentFormData.beltNo,
                    AccountNo: currentFormData.gpFundNo,
                    CNIC: currentFormData.cnic,
                    Percentage: currentFormData.percentage,
                    TotalBalance: currentFormData.totalBalance.toLocaleString('en-PK'),
                    MonthlyInstallment: currentFormData.monthlyInstallment.toLocaleString('en-PK'),
                    Installments: currentFormData.installments
                };

                doc.setData(exportData);
                doc.render();

                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });

                const fileName = `GP_Advance_${currentFormData.applicantName.replace(/\s/g, '_')}.docx`;
                saveAs(out, fileName);
                
                alert("‚úÖ DOCX generated with your template formatting!");
                
            } catch (error) {
                throw error;
            }
        }

        async function generateSimpleDocument() {
            const today = new Date();
            const content = createDocumentContent(currentFormData, today);
            
            // Create a simple DOCX
            const simpleDocx = await createSimpleDocx(content);
            const fileName = `GP_Advance_${currentFormData.applicantName.replace(/\s/g, '_')}.docx`;
            saveAs(simpleDocx, fileName);
            
            alert("‚úÖ Simple DOCX generated (template not available)");
        }

        function createDocumentContent(data, date) {
            return `Government of the Punjab
Police Department

No. /Acct/SPU Dated ${date.toLocaleDateString('en-GB')}

ORDER:

In exercise of the powers vested in me under Rule.1.14(1)(a)(iv)(d)(i)
of the Punjab Provident Fund Rules, 1978, sanction is hereby accorded to
the grant of refundable advance of Rs.${data.advanceAmount.toLocaleString('en-PK')}/- (Rupees ${data.amountWords}) in respect of 
Mr. ${data.applicantName} ${data.rank} ${data.beltNo} of Special Protection Unit (SPU) Punjab Lahore 
from his G.P. Fund Account as mentioned in his G.P. Fund/Personal Account 
No. ${data.gpFundNo} and CNIC No. ${data.cnic} For construction/repairing of his house. 
The amount is approximately equal to ${data.percentage}% of the balance at his 
credit in his G.P. Fund account Rs. ${data.totalBalance.toLocaleString('en-PK')}/-.

2. The recovery of the advance shall be made at the rate of Rs. ${data.monthlyInstallment.toLocaleString('en-PK')}/- 
in ${data.installments} equal installments from the pay of subscriber which will commence 
from the pay of the month following the month in which the advance is drawn.

3. It is certified that there is sufficient balance at his credit to
meet the advance. The amount of advance is debatable under head
G-Liabilities-G06-Trust Account Fund-G061-Provident Fund-G06103-General
Provident Fund (Civil)-LO5635.

Additional Director Admin/DDO,
for Director/Deputy Inspector General of Police,
Special Protection Unit,
Punjab, Lahore.

No. /Acct/SPU Dated ${date.toLocaleDateString('en-GB')}

A copy is forwarded for information and necessary action to the:-

I. Accountant General, Punjab, Lahore.

Additional Director Admin/DDO,
for Director/Deputy Inspector General of Police,
Special Protection Unit,
Punjab, Lahore`;
        }

        async function createSimpleDocx(content) {
            // Simple DOCX structure
            const simpleDocx = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
    <w:body>
        <w:p>
            <w:r>
                <w:t>${escapeXml(content).replace(/\n/g, '</w:t></w:r></w:p><w:p><w:r><w:t>')}</w:t>
            </w:r>
        </w:p>
    </w:body>
</w:document>`;
            
            return new Blob([simpleDocx], { 
                type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' 
            });
        }

        function escapeXml(unsafe) {
            return unsafe.replace(/[<>&'"]/g, function (c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                    default: return c;
                }
            });
        }

        // =========================================================
        // 5. DAILY & MASTER REPORTS (CONTINUED IN NEXT MESSAGE)
        // =========================================================

        // Note: Due to character limit, continuing in next message...
        
        // Initialize the rest of the system
        window.onload = async () => {
            updateCalculations();
            await checkTemplateFile();
            
            // Set today's date
            document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
            
            // Initialize tabs
            const triggerTabList = [].slice.call(document.querySelectorAll('#myTab button'));
            triggerTabList.forEach(function (triggerEl) {
                var tabTrigger = new bootstrap.Tab(triggerEl);
                triggerEl.addEventListener('click', function (event) {
                    event.preventDefault();
                    tabTrigger.show();
                });
            });
            
            // Load data
            setTimeout(() => {
                if (window.firebaseModules) {
                    loadApplications();
                }
            }, 1000);
            
            document.getElementById('totalBalance').addEventListener('input', updateCalculations);
        };

        // Note: The rest of the functions (Firestore, Dashboard, Reports) 
        // will be continued in the next message due to character limit...
    </script>
</body>
</html>
