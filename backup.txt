<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Automation System - Hybrid Prototype</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs (Modular Version - Your Config) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCpaMthWl0eQwYXN-wt09fv_OqS4iUVxLA",
            authDomain: "welfare-das.firebaseapp.com",
            projectId: "welfare-das",
            storageBucket: "welfare-das.firebasestorage.app",
            messagingSenderId: "783240912416",
            appId: "1:783240912416:web:86c8b859e1b7162d0aa645",
            measurementId: "G-FGRCLWVY6B"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make them globally available
        window.firebaseModules = {
            db,
            collection,
            addDoc,
            serverTimestamp,
            onSnapshot,
            query,
            orderBy,
            deleteDoc,
            doc
        };
        console.log("‚úÖ Firebase initialized successfully!");
    </script>
    
    <!-- Docx Libraries -->
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.47.0/docxtemplater.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        body { background-color: #e9ecef; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 1200px; margin: 30px auto; }
        .form-section, .dashboard-section { background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 30px; }
        .calculated-field { font-weight: bold; color: #007bff; background-color: #f0f8ff; border-radius: 5px; padding: 8px; }
        .date-group { border: 1px solid #ddd; margin-top: 15px; padding: 15px; border-radius: 8px; background-color: #fafafa; }
        .date-header { display: flex; justify-content: space-between; align-items: center; background-color: #e2e6ea; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .date-header h5 { margin: 0; color: #333; }
        .loading { display: none; }
        .spinner-border { width: 1rem; height: 1rem; }
        .firestore-status { 
            padding: 8px 15px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            margin-bottom: 15px;
            text-align: center;
        }
        .status-connected { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-disconnected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="text-center text-primary mb-3">‚úÖ Document Automation System</h1>
        <div id="firestoreStatus" class="firestore-status status-disconnected">
            üî¥ Firestore: Disconnected
        </div>
        
        <div class="form-section">
            <h3 class="mb-4 text-success">üìù New Application Entry (Form)</h3>
            <form id="advanceForm" oninput="updateCalculations()">
                
                <div class="row g-3">
                    <div class="col-md-6"><label for="applicantName" class="form-label">Applicant Name</label><input type="text" class="form-control" id="applicantName" required></div>
                    <div class="col-md-6"><label for="rank" class="form-label">Rank / Designation</label><input type="text" class="form-control" id="rank" required></div>
                    <div class="col-md-4"><label for="beltNo" class="form-label">Belt No</label><input type="text" class="form-control" id="beltNo" required></div>
                    <div class="col-md-4"><label for="cnic" class="form-label">CNIC Number</label><input type="text" class="form-control" id="cnic" maxlength="15" required onkeyup="validateCNIC(this)"></div>
                    <div class="col-md-4"><label for="gpFundNo" class="form-label">GP Fund Account No</label><input type="text" class="form-control" id="gpFundNo" required></div>
                </div>
                
                <hr class="my-4">

                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="totalBalance" class="form-label">Total GP Balance (PKR)</label>
                        <input type="number" class="form-control" id="totalBalance" min="1" step="1" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Withdrawal Amount (PKR)</label>
                        <div id="advanceAmountDisplay" class="form-control calculated-field">0</div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Installments (Months)</label>
                        <div id="installmentsDisplay" class="form-control calculated-field">0</div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Monthly Installment (PKR)</label>
                        <div id="monthlyInstallment" class="form-control calculated-field">0</div>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Withdrawal Amount (Words)</label>
                        <div id="advanceAmountWords" class="form-control calculated-field text-danger">Zero Only</div>
                    </div>
                </div>
                
                <input type="hidden" id="advanceAmount" value="0"> 
                <input type="hidden" id="installments" value="0">
                <input type="hidden" id="monthlyInstallmentValue" value="0">

                <div class="d-grid gap-2 mt-4">
                    <button type="button" class="btn btn-success btn-lg" id="submitBtn" onclick="saveToFirestore()">
                        <span id="submitText">Submit Data to Firestore</span>
                        <span class="loading" id="submitLoading">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            Saving to Firestore...
                        </span>
                    </button>
                    
                    <button type="button" class="btn btn-primary btn-lg mt-2" id="downloadBtn" onclick="generateDocx()" disabled>
                        <span id="downloadText">Download DOCX File</span>
                        <span class="loading" id="downloadLoading">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            Generating DOCX...
                        </span>
                    </button>
                </div>
                
            </form>
        </div>

        <div class="dashboard-section">
            <h3 class="mb-4 text-secondary">üìä Real-Time Applications from Firestore</h3>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <button class="btn btn-info w-100" onclick="exportAllToDocx()">
                        <i class="fas fa-download"></i> Export All DOCX
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-warning w-100" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export to Excel
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-secondary w-100" onclick="clearForm()">
                        <i class="fas fa-redo"></i> Clear Form
                    </button>
                </div>
            </div>

            <hr>
            
            <h4 class="mt-4">
                <i class="fas fa-database"></i> Applications List
                <span id="totalCountBadge" class="badge bg-primary ms-2">0</span>
            </h4>
            <div id="applicationsList">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading applications from Firestore...</p>
                </div>
            </div>
            
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script>
        // =========================================================
        // 1. GLOBAL VARIABLES
        // =========================================================
        const CONSTANTS = {
            MIN_INSTALLMENTS: 28,
            MAX_INSTALLMENTS: 36,
            MIN_PERCENTAGE: 0.75,
            MAX_PERCENTAGE: 0.80
        };

        let currentFormData = null;
        let allApplications = [];
        let unsubscribe = null; // For Firestore listener

        // =========================================================
        // 2. CALCULATION FUNCTIONS
        // =========================================================
        function numberToWordsPakistani(n) {
            if (n === 0) return "Zero Only";
            if (n < 0) return "Negative " + numberToWordsPakistani(-n);
            
            const ones = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
            const teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
            const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
            
            function convertHundreds(num) {
                let result = "";
                if (num >= 100) {
                    result += ones[Math.floor(num / 100)] + " Hundred ";
                    num %= 100;
                }
                if (num >= 20) {
                    result += tens[Math.floor(num / 10)] + " ";
                    num %= 10;
                } else if (num >= 10) {
                    result += teens[num - 10] + " ";
                    num = 0;
                }
                if (num > 0) {
                    result += ones[num] + " ";
                }
                return result.trim();
            }
            
            let result = "";
            let num = Math.floor(n);
            
            if (num >= 10000000) { // Crore
                result += convertHundreds(Math.floor(num / 10000000)) + " Crore ";
                num %= 10000000;
            }
            
            if (num >= 100000) { // Lakh
                result += convertHundreds(Math.floor(num / 100000)) + " Lakh ";
                num %= 100000;
            }
            
            if (num >= 1000) { // Thousand
                result += convertHundreds(Math.floor(num / 1000)) + " Thousand ";
                num %= 1000;
            }
            
            result += convertHundreds(num);
            
            return result.trim() + " Only";
        }

        function calculateOptimalAdvance(balance) {
            if (balance <= 0) return { advance: 0, installments: 0, monthly: 0, percentage: 0 };

            const minAllowed = Math.ceil(balance * CONSTANTS.MIN_PERCENTAGE);
            const maxAllowed = Math.floor(balance * CONSTANTS.MAX_PERCENTAGE);

            for (let withdrawal = maxAllowed; withdrawal >= minAllowed; withdrawal--) {
                for (let months = CONSTANTS.MAX_INSTALLMENTS; months >= CONSTANTS.MIN_INSTALLMENTS; months--) {
                    const monthly = withdrawal / months;
                    if (Number.isInteger(monthly) && monthly >= 1) {
                        return {
                            advance: withdrawal,
                            installments: months,
                            monthly: monthly,
                            percentage: ((withdrawal / balance) * 100).toFixed(2)
                        };
                    }
                }
            }
            return { advance: 0, installments: 0, monthly: 0, percentage: 0 };
        }

        function updateCalculations() {
            const balance = parseInt(document.getElementById('totalBalance').value) || 0;
            const result = calculateOptimalAdvance(balance);
            
            document.getElementById('advanceAmountDisplay').textContent = result.advance.toLocaleString('en-PK');
            document.getElementById('installmentsDisplay').textContent = result.installments;
            document.getElementById('monthlyInstallment').textContent = result.monthly.toLocaleString('en-PK');
            document.getElementById('advanceAmountWords').textContent = numberToWordsPakistani(result.advance);

            document.getElementById('advanceAmount').value = result.advance;
            document.getElementById('installments').value = result.installments;
            document.getElementById('monthlyInstallmentValue').value = result.monthly;
        }

        function validateCNIC(input) {
            const cnicPattern = /^\d{5}-\d{7}-\d{1}$/;
            let value = input.value.replace(/[^\d]/g, '');
            
            if (value.length > 0) {
                if (value.length <= 5) {
                    input.value = value;
                } else if (value.length <= 12) {
                    input.value = value.slice(0, 5) + '-' + value.slice(5);
                } else {
                    input.value = value.slice(0, 5) + '-' + value.slice(5, 12) + '-' + value.slice(12, 13);
                }
            }
            
            input.classList.toggle('is-invalid', !cnicPattern.test(input.value) && input.value.length > 0);
        }

        // =========================================================
        // 3. FIRESTORE OPERATIONS
        // =========================================================
        async function saveToFirestore() {
            if (!window.firebaseModules) {
                alert("Firebase is not initialized yet. Please wait...");
                return;
            }

            const form = document.getElementById('advanceForm');
            if (!form.checkValidity() || document.getElementById('cnic').classList.contains('is-invalid')) {
                form.classList.add('was-validated');
                alert("Please fill all required fields correctly and ensure CNIC format is 12345-1234567-1");
                return;
            }

            const balance = parseInt(document.getElementById('totalBalance').value) || 0;
            const result = calculateOptimalAdvance(balance);
            
            if (result.advance === 0) {
                alert("Calculation Error: Could not calculate valid advance amount. Please check Total GP Balance.");
                return;
            }

            // Show loading
            document.getElementById('submitText').style.display = 'none';
            document.getElementById('submitLoading').style.display = 'inline';
            document.getElementById('submitBtn').disabled = true;

            // Prepare data for Firestore
            const applicationData = {
                applicantName: document.getElementById('applicantName').value.trim(),
                rank: document.getElementById('rank').value.trim(),
                beltNo: document.getElementById('beltNo').value.trim(),
                cnic: document.getElementById('cnic').value.trim(),
                gpFundNo: document.getElementById('gpFundNo').value.trim(),
                totalBalance: balance,
                advanceAmount: result.advance,
                installments: result.installments,
                monthlyInstallment: result.monthly,
                amountWords: numberToWordsPakistani(result.advance),
                percentage: result.percentage,
                createdAt: window.firebaseModules.serverTimestamp(),
                status: 'pending',
                submittedAt: new Date().toISOString()
            };

            try {
                const { db, addDoc, collection } = window.firebaseModules;
                const applicationsRef = collection(db, "applications");
                
                const docRef = await addDoc(applicationsRef, applicationData);
                console.log("‚úÖ Document written with ID: ", docRef.id);
                
                // Store locally for DOCX generation
                currentFormData = {
                    ...applicationData,
                    id: docRef.id,
                    createdDate: new Date().toISOString().split('T')[0]
                };

                // Enable download button
                document.getElementById('downloadBtn').disabled = false;
                
                // Reset form
                form.reset();
                updateCalculations();
                
                // Show success message
                showAlert('‚úÖ Application saved to Firestore successfully!', 'success');
                
            } catch (error) {
                console.error("‚ùå Error adding document: ", error);
                showAlert('‚ùå Error saving to Firestore: ' + error.message, 'danger');
            } finally {
                // Hide loading
                document.getElementById('submitText').style.display = 'inline';
                document.getElementById('submitLoading').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
            }
        }

        function loadApplications() {
            if (!window.firebaseModules) {
                console.log("Firebase modules not loaded yet");
                setTimeout(loadApplications, 1000);
                return;
            }

            const { db, collection, query, orderBy, onSnapshot } = window.firebaseModules;
            const applicationsRef = collection(db, "applications");
            
            // Update status
            document.getElementById('firestoreStatus').className = 'firestore-status status-connected';
            document.getElementById('firestoreStatus').innerHTML = 'üü¢ Firestore: Connected (Live Updates)';
            
            // Create query
            const q = query(applicationsRef, orderBy('createdAt', 'desc'));
            
            // Set up real-time listener
            unsubscribe = onSnapshot(q, (snapshot) => {
                allApplications = [];
                const applicationsList = document.getElementById('applicationsList');
                
                if (snapshot.empty) {
                    applicationsList.innerHTML = '<p class="text-center text-muted">No applications found. Submit your first application!</p>';
                    document.getElementById('totalCountBadge').textContent = '0';
                    return;
                }

                let groupedByDate = {};
                let totalCount = 0;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    // Convert Firestore timestamp to date
                    let dateStr = 'No Date';
                    if (data.createdAt) {
                        const date = data.createdAt.toDate();
                        dateStr = date.toISOString().split('T')[0];
                    }
                    
                    const app = { 
                        id, 
                        ...data,
                        formattedDate: dateStr
                    };
                    
                    allApplications.push(app);
                    totalCount++;

                    if (!groupedByDate[dateStr]) {
                        groupedByDate[dateStr] = [];
                    }
                    groupedByDate[dateStr].push(app);
                });

                // Update total count
                document.getElementById('totalCountBadge').textContent = totalCount;

                // Display grouped applications
                let html = '';
                const dates = Object.keys(groupedByDate).sort().reverse();
                
                if (dates.length === 0) {
                    html = '<p class="text-center text-muted">No applications found.</p>';
                } else {
                    dates.forEach(date => {
                        const apps = groupedByDate[date];
                        html += `
                            <div class="date-group">
                                <div class="date-header">
                                    <h5>üìÖ ${date} <span class="badge bg-secondary ms-2">${apps.length} Applications</span></h5>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Rank</th>
                                                <th>Amount</th>
                                                <th>Installments</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${apps.map(app => `
                                                <tr>
                                                    <td>${app.applicantName || 'N/A'}</td>
                                                    <td>${app.rank || 'N/A'}</td>
                                                    <td>PKR ${(app.advanceAmount || 0).toLocaleString('en-PK')}</td>
                                                    <td>${app.installments || 0} months</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="downloadSingleDocx('${app.id}')">
                                                            <i class="fas fa-download"></i> DOCX
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteApplication('${app.id}')">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    });
                }
                
                applicationsList.innerHTML = html;
                
            }, (error) => {
                console.error("‚ùå Error loading applications:", error);
                document.getElementById('firestoreStatus').className = 'firestore-status status-disconnected';
                document.getElementById('firestoreStatus').innerHTML = 'üî¥ Firestore: Error - ' + error.message;
                document.getElementById('applicationsList').innerHTML = 
                    '<p class="text-center text-danger">Error loading applications from Firestore. Please refresh.</p>';
            });
        }

        async function deleteApplication(appId) {
            if (!confirm("Are you sure you want to delete this application? This action cannot be undone.")) {
                return;
            }

            try {
                const { db, doc, deleteDoc } = window.firebaseModules;
                await deleteDoc(doc(db, "applications", appId));
                showAlert('‚úÖ Application deleted successfully!', 'success');
            } catch (error) {
                console.error("Error deleting document:", error);
                showAlert('‚ùå Error deleting application: ' + error.message, 'danger');
            }
        }

        // =========================================================
        // 4. DOCX GENERATION
        // =========================================================
        async function generateDocx() {
            if (!currentFormData) {
                const latestApp = allApplications[0];
                if (latestApp) {
                    currentFormData = latestApp;
                } else {
                    alert("Please save data to Firestore first or select an application from the list.");
                    return;
                }
            }

            // Show loading
            document.getElementById('downloadText').style.display = 'none';
            document.getElementById('downloadLoading').style.display = 'inline';
            document.getElementById('downloadBtn').disabled = true;

            try {
                const response = await fetch('template.docx');
                if (!response.ok) {
                    throw new Error("Template file 'template.docx' not found in root folder");
                }
                
                const content = await response.arrayBuffer();
                const zip = new PizZip(content);
                const doc = new docxtemplater(zip, { 
                    paragraphLoop: true, 
                    linebreaks: true 
                });

                const today = new Date();
                const exportData = {
                    ApplicantName: currentFormData.applicantName || '',
                    Rank: currentFormData.rank || '',
                    BeltNo: currentFormData.beltNo || '',
                    CNIC: currentFormData.cnic || '',
                    AccountNo: currentFormData.gpFundNo || '',
                    TotalBalance: (currentFormData.totalBalance || 0).toLocaleString('en-PK'),
                    AdvanceAmount: (currentFormData.advanceAmount || 0).toLocaleString('en-PK'),
                    Installments: currentFormData.installments || 0,
                    MonthlyInstallment: (currentFormData.monthlyInstallment || 0).toLocaleString('en-PK'),
                    AmountWords: currentFormData.amountWords || 'Zero Only',
                    Percentage: currentFormData.percentage || '0.00',
                    CurrentDate: today.toLocaleDateString('en-GB'),
                    Day: today.getDate(),
                    Month: today.toLocaleString('en-US', { month: 'long' }),
                    Year: today.getFullYear()
                };

                doc.setData(exportData);
                doc.render();

                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });

                const fileName = `GP_Advance_${currentFormData.applicantName || 'Application'}_${today.getTime()}.docx`
                    .replace(/\s+/g, '_')
                    .replace(/[^\w\-.]/g, '');
                
                saveAs(out, fileName);
                showAlert('‚úÖ DOCX file downloaded successfully!', 'success');
                
            } catch (error) {
                console.error("DOCX Generation Error:", error);
                showAlert('‚ùå Error generating document: ' + error.message, 'danger');
            } finally {
                // Hide loading
                document.getElementById('downloadText').style.display = 'inline';
                document.getElementById('downloadLoading').style.display = 'none';
                document.getElementById('downloadBtn').disabled = false;
            }
        }

        async function downloadSingleDocx(appId) {
            const app = allApplications.find(a => a.id === appId);
            if (!app) {
                showAlert('Application not found in local cache.', 'warning');
                return;
            }

            currentFormData = app;
            await generateDocx();
        }

        // =========================================================
        // 5. UTILITY FUNCTIONS
        // =========================================================
        function exportAllToDocx() {
            if (allApplications.length === 0) {
                showAlert("No applications to export.", 'warning');
                return;
            }
            
            // This would typically generate a ZIP file with all DOCX
            // For now, just show a message
            showAlert(`Would generate ${allApplications.length} DOCX files in a production environment.`, 'info');
        }

        function exportToExcel() {
            if (allApplications.length === 0) {
                showAlert("No applications to export.", 'warning');
                return;
            }
            
            // Simple CSV export
            const headers = ["Name", "Rank", "Belt No", "CNIC", "GP Fund No", "Total Balance", "Advance Amount", "Installments", "Monthly Installment", "Date"];
            const csvData = allApplications.map(app => [
                `"${app.applicantName || ''}"`,
                `"${app.rank || ''}"`,
                `"${app.beltNo || ''}"`,
                `"${app.cnic || ''}"`,
                `"${app.gpFundNo || ''}"`,
                app.totalBalance || 0,
                app.advanceAmount || 0,
                app.installments || 0,
                app.monthlyInstallment || 0,
                app.formattedDate || 'N/A'
            ]);
            
            const csv = [headers, ...csvData].map(row => row.join(",")).join("\n");
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `applications_export_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('‚úÖ Excel (CSV) file downloaded successfully!', 'success');
        }

        function clearForm() {
            document.getElementById('advanceForm').reset();
            updateCalculations();
            currentFormData = null;
            document.getElementById('downloadBtn').disabled = true;
            showAlert('Form cleared successfully!', 'info');
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Remove existing alerts
            document.querySelectorAll('.alert').forEach(el => el.remove());
            
            // Add new alert at top
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // =========================================================
        // 6. INITIALIZATION
        // =========================================================
        window.onload = async () => {
            // Initialize calculations
            updateCalculations();
            
            // Listen for form changes
            document.getElementById('totalBalance').addEventListener('input', updateCalculations);
            
            // Wait for Firebase to load
            const checkFirebase = setInterval(() => {
                if (window.firebaseModules) {
                    clearInterval(checkFirebase);
                    console.log("üî• Firebase modules loaded, starting application...");
                    loadApplications();
                }
            }, 100);
            
            // Safety timeout
            setTimeout(() => {
                if (!window.firebaseModules) {
                    console.error("Firebase failed to load after 10 seconds");
                    document.getElementById('firestoreStatus').innerHTML = 
                        'üî¥ Firestore: Failed to initialize. Check console.';
                }
            }, 10000);
        };

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });
    </script>
</body>
</html>