<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPU Punjab - GP Fund Advance System</title>
    
    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- JSZip for Word Documents -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- docxtemplater for Word Template -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.47.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.1.0/jszip-utils.min.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    
    <style>
        :root {
            --sidebar-width: 250px;
            --primary-bg: #212529;
            --active-color: #0d6efd;
        }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: #f4f6f9; 
            overflow-x: hidden; 
        }
        
        /* Sidebar Styles */
        #sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
            background: linear-gradient(180deg, #2c3e50 0%, #1a252f 100%);
            color: white;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .sidebar-header { 
            padding: 20px; 
            font-size: 1.2rem; 
            font-weight: bold; 
            border-bottom: 1px solid #3d4246; 
        }
        .nav-link { 
            color: #cfd2d6; 
            padding: 15px 20px; 
            border-left: 4px solid transparent; 
            cursor: pointer; 
        }
        .nav-link:hover, .nav-link.active { 
            background: #343a40; 
            color: white; 
            border-left-color: var(--active-color); 
        }
        .nav-link i { width: 25px; margin-right: 10px; }
        
        /* Main Content */
        #content { 
            margin-left: var(--sidebar-width); 
            transition: all 0.3s; 
            width: calc(100% - var(--sidebar-width)); 
        }
        
        .top-bar { 
            background: white; 
            padding: 15px 30px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .main-container { padding: 30px; }
        
        /* Cards & Stats */
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            border-left: 5px solid;
        }
        .stat-card:nth-child(1) { border-left-color: #4caf50; }
        .stat-card:nth-child(2) { border-left-color: #2196f3; }
        .stat-card:nth-child(3) { border-left-color: #ff9800; }
        
        .stat-number { font-size: 1.8rem; font-weight: bold; color: #212529; }
        .stat-label { color: #6c757d; font-size: 0.9rem; }
        .stat-icon { font-size: 2.5rem; opacity: 0.2; }
        
        .app-card { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
        }
        
        /* Helper Classes */
        .hidden { display: none; }
        .calculated-field { 
            background-color: #e9ecef; 
            font-weight: bold; 
            color: #0d6efd;
            border: 1px solid #ced4da;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            border: none;
        }
        
        @media (max-width: 768px) {
            #sidebar { margin-left: -var(--sidebar-width); }
            #content { margin-left: 0; width: 100%; }
            body.sidebar-active #sidebar { margin-left: 0; }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div id="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-shield-alt me-2"></i> SPU Punjab
            <p class="small mb-0" style="color: #aaa;">GP Fund System</p>
        </div>
        <nav class="nav flex-column mt-3">
            <a class="nav-link active" onclick="switchTab('dashboard')"><i class="fas fa-th-large"></i> Dashboard</a>
            <a class="nav-link" onclick="switchTab('new-entry')"><i class="fas fa-plus-circle"></i> New Application</a>
            <a class="nav-link" onclick="switchTab('reports')"><i class="fas fa-file-word"></i> Generate Reports</a>
            <a class="nav-link" onclick="switchTab('database')"><i class="fas fa-database"></i> Master Database</a>
            <a class="nav-link" onclick="switchTab('settings')"><i class="fas fa-cog"></i> Settings</a>
        </nav>
    </div>

    <!-- Main Content -->
    <div id="content">
        <div class="top-bar">
            <button class="btn btn-outline-secondary d-md-none" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <h5 class="m-0 text-secondary" id="page-title">Dashboard</h5>
            <div class="text-muted small" id="current-date"></div>
        </div>

        <div class="main-container">
            
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="content-section">
                <div class="row">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div>
                                <div class="stat-number" id="total-count">0</div>
                                <div class="stat-label">Total Applications</div>
                            </div>
                            <i class="fas fa-users stat-icon text-primary"></i>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div>
                                <div class="stat-number" id="today-count">0</div>
                                <div class="stat-label">Today's Applications</div>
                            </div>
                            <i class="fas fa-calendar-check stat-icon text-success"></i>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div>
                                <div class="stat-number" id="total-amount">0</div>
                                <div class="stat-label">Total Amount (Millions)</div>
                            </div>
                            <i class="fas fa-money-bill-wave stat-icon text-warning"></i>
                        </div>
                    </div>
                </div>

                <div class="app-card">
                    <h5 class="mb-3">Recent Applications</h5>
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Rank</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="recent-table">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- New Application Tab -->
            <div id="new-entry-tab" class="content-section hidden">
                <div class="app-card">
                    <h4 class="mb-4 text-primary">New GP Fund Advance Application</h4>
                    <form id="entryForm" oninput="calculateDetails()">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Applicant Name *</label>
                                <input type="text" class="form-control" id="f_name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Rank / Designation *</label>
                                <select class="form-control" id="f_rank" required>
                                    <option value="">Select Rank</option>
                                    <option value="Constable">Constable</option>
                                    <option value="Head Constable">Head Constable</option>
                                    <option value="ASI">Assistant Sub Inspector</option>
                                    <option value="SI">Sub Inspector</option>
                                    <option value="Inspector">Inspector</option>
                                    <option value="DSP">Deputy Superintendent</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Belt No *</label>
                                <input type="text" class="form-control" id="f_belt" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">CNIC *</label>
                                <input type="text" class="form-control" id="f_cnic" placeholder="XXXXX-XXXXXXX-X" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">GP Fund Account No *</label>
                                <input type="text" class="form-control" id="f_account" required>
                            </div>
                            
                            <div class="col-12"><hr></div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Total GP Balance *</label>
                                <input type="number" class="form-control border-primary" id="f_balance" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label text-muted">Advance Amount (80%)</label>
                                <input type="text" class="form-control calculated-field" id="c_advance" readonly>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label text-muted">Percentage</label>
                                <input type="text" class="form-control calculated-field" id="c_percentage" readonly>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted">Installments</label>
                                <input type="text" class="form-control calculated-field" id="c_inst" readonly>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted">Monthly Ded.</label>
                                <input type="text" class="form-control calculated-field" id="c_monthly" readonly>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted">Recovery Period</label>
                                <input type="text" class="form-control calculated-field" id="c_period" value="36 Months" readonly>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label text-muted">Amount in Words</label>
                                <input type="text" class="form-control calculated-field text-danger fw-bold" id="c_words" readonly>
                            </div>

                            <div class="col-12 mt-4">
                                <button type="button" class="btn btn-primary btn-lg w-100" onclick="saveApplication()">
                                    <i class="fas fa-save"></i> Save Application & Generate Letter
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="content-section hidden">
                <div class="app-card border-start border-4 border-success">
                    <h4><i class="fas fa-file-word"></i> Generate Letters</h4>
                    <p class="text-muted">Select a date to download letters in Word format.</p>
                    
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Select Date</label>
                            <input type="date" class="form-control" id="report-date" value="">
                        </div>
                        <div class="col-md-8">
                            <button class="btn btn-success" onclick="generateBatchWord()">
                                <i class="fas fa-file-word"></i> Download Merged Word File (.docx)
                            </button>
                            <button class="btn btn-outline-success" onclick="generateBatchExcel()">
                                <i class="fas fa-file-excel"></i> Download Excel Report
                            </button>
                        </div>
                    </div>
                </div>

                <div class="app-card mt-3">
                    <h5>Applications on Selected Date</h5>
                    <div id="date-list" class="text-muted small mt-2">
                        Select a date above to view records...
                    </div>
                </div>
            </div>

            <!-- Database Tab -->
            <div id="database-tab" class="content-section hidden">
                <div class="app-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Master Database</h4>
                        <button class="btn btn-success btn-sm" onclick="exportMasterExcel()">
                            <i class="fas fa-download"></i> Export All to Excel
                        </button>
                    </div>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-striped table-sm">
                            <thead class="sticky-top bg-white">
                                <tr>
                                    <th>Date</th>
                                    <th>Name</th>
                                    <th>Rank</th>
                                    <th>Belt</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="master-table">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="content-section hidden">
                <div class="app-card">
                    <h4 class="mb-4"><i class="fas fa-cog"></i> System Settings</h4>
                    
                    <div class="mb-3">
                        <label class="form-label">Maximum Advance Percentage</label>
                        <input type="range" class="form-range" id="max-percentage" min="50" max="90" value="80">
                        <div class="d-flex justify-content-between">
                            <small>50%</small>
                            <strong id="percentage-value">80%</strong>
                            <small>90%</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Default Installments</label>
                        <select class="form-control" id="default-installments">
                            <option value="12">12 Months</option>
                            <option value="24">24 Months</option>
                            <option value="36" selected>36 Months</option>
                            <option value="48">48 Months</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Letter Number Prefix</label>
                        <input type="text" class="form-control" id="letter-prefix" value="/Acct/SPU">
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save me-2"></i> Save Settings
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCpaMthWl0eQwYXN-wt09fv_OqS4iUVxLA",
            authDomain: "welfare-das.firebaseapp.com",
            projectId: "welfare-das",
            storageBucket: "welfare-das.appspot.com",
            messagingSenderId: "783240912416",
            appId: "1:783240912416:web:86c8b859e1b7162d0aa645",
            measurementId: "G-FGRCLWVY6B"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Export to window for global access
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.query = query;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
    </script>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // ===== GLOBAL VARIABLES =====
        let allApplications = [];
        let rawFormData = {};
        let settings = {
            maxPercentage: 80,
            installments: 36,
            letterPrefix: '/Acct/SPU'
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const now = new Date();
            document.getElementById('current-date').textContent = 
                now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            
            // Set default date for report
            document.getElementById('report-date').value = now.toISOString().split('T')[0];
            
            // Load applications from Firebase
            loadApplications();
            
            // Load settings
            loadSettings();
            
            // Setup CNIC formatting
            document.getElementById('f_cnic').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 5) value = value.substring(0,5) + '-' + value.substring(5);
                if (value.length > 13) value = value.substring(0,13) + '-' + value.substring(13);
                if (value.length > 15) value = value.substring(0,15);
                e.target.value = value;
            });

            // Setup percentage slider
            document.getElementById('max-percentage').addEventListener('input', function() {
                document.getElementById('percentage-value').textContent = this.value + '%';
                settings.maxPercentage = parseInt(this.value);
                calculateDetails(); // Recalculate if balance exists
            });
        });

        // ===== NAVIGATION =====
        function toggleSidebar() {
            document.body.classList.toggle('sidebar-active');
        }

        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabId + '-tab').classList.remove('hidden');
            
            // Activate menu item
            document.querySelector(`.nav-link[onclick="switchTab('${tabId}')"]`).classList.add('active');
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'new-entry': 'New Application',
                'reports': 'Generate Reports',
                'database': 'Master Database',
                'settings': 'Settings'
            };
            document.getElementById('page-title').textContent = titles[tabId];
        }

        // ===== CALCULATION FUNCTIONS =====
        function calculateDetails() {
            const balance = parseFloat(document.getElementById('f_balance').value) || 0;
            if(balance <= 0) {
                resetCalculatedFields();
                return;
            }

            // Calculate advance (based on settings percentage)
            let advance = Math.floor(balance * (settings.maxPercentage / 100));
            
            // Calculate monthly installment (based on settings installments)
            const installments = settings.installments;
            let monthly = Math.ceil(advance / installments);
            
            // Adjust for exact division
            if (advance % installments !== 0) {
                monthly = Math.floor(advance / installments);
                advance = monthly * installments;
            }
            
            const percentage = ((advance / balance) * 100).toFixed(2);

            // Update UI
            document.getElementById('c_advance').value = advance.toLocaleString();
            document.getElementById('c_percentage').value = percentage + "%";
            document.getElementById('c_inst').value = installments;
            document.getElementById('c_monthly').value = monthly.toLocaleString();
            document.getElementById('c_words').value = numberToWords(advance);

            // Store data for saving
            rawFormData = {
                advance: advance,
                percentage: percentage,
                installments: installments,
                monthly: monthly,
                words: numberToWords(advance)
            };
        }

        function resetCalculatedFields() {
            document.getElementById('c_advance').value = '';
            document.getElementById('c_percentage').value = '';
            document.getElementById('c_inst').value = '';
            document.getElementById('c_monthly').value = '';
            document.getElementById('c_words').value = '';
            rawFormData = {};
        }

        function numberToWords(num) {
            if(num === 0) return "Zero Only";
            const a = ['','One ','Two ','Three ','Four ','Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
            const b = ['', '', 'Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
            
            const n2words = (n) => {
                if ((n = n.toString()).length > 9) return 'overflow';
                let n_array = ('000000000' + n).slice(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
                if (!n_array) return; 
                let str = '';
                str += (n_array[1] != 0) ? (a[Number(n_array[1])] || b[n_array[1][0]] + ' ' + a[n_array[1][1]]) + 'Crore ' : '';
                str += (n_array[2] != 0) ? (a[Number(n_array[2])] || b[n_array[2][0]] + ' ' + a[n_array[2][1]]) + 'Lakh ' : '';
                str += (n_array[3] != 0) ? (a[Number(n_array[3])] || b[n_array[3][0]] + ' ' + a[n_array[3][1]]) + 'Thousand ' : '';
                str += (n_array[4] != 0) ? (a[Number(n_array[4])] || b[n_array[4][0]] + ' ' + a[n_array[4][1]]) + 'Hundred ' : '';
                str += (n_array[5] != 0) ? (a[Number(n_array[5])] || b[n_array[5][0]] + ' ' + a[n_array[5][1]]) + ' ' : '';
                return str;
            };
            return n2words(num).trim() + " Rupees Only";
        }

        // ===== FIREBASE OPERATIONS =====
        function loadApplications() {
            if(window.onSnapshot && window.db) {
                const q = window.query(window.collection(window.db, "applications"), window.orderBy("timestamp", "desc"));
                
                window.onSnapshot(q, (snapshot) => {
                    allApplications = [];
                    snapshot.forEach(doc => {
                        allApplications.push({ 
                            id: doc.id, 
                            ...doc.data() 
                        });
                    });
                    
                    updateDashboard();
                    updateMasterTable();
                    updateRecentTable();
                    
                    // Update report preview
                    updateReportPreview();
                });
            } else {
                console.log("Firebase not initialized yet");
                setTimeout(loadApplications, 1000);
            }
        }

        async function saveApplication() {
            try {
                // Validate form
                const name = document.getElementById('f_name').value.trim();
                const balance = document.getElementById('f_balance').value;
                
                if(!name || !balance || !rawFormData.advance) {
                    alert("Please fill all required fields and calculate advance amount");
                    return;
                }

                // Prepare data for Firebase
                const applicationData = {
                    name: name,
                    rank: document.getElementById('f_rank').value.trim(),
                    belt: document.getElementById('f_belt').value.trim(),
                    cnic: document.getElementById('f_cnic').value.trim(),
                    account: document.getElementById('f_account').value.trim(),
                    balance: parseFloat(balance),
                    
                    // Calculated fields
                    advance: rawFormData.advance,
                    percentage: rawFormData.percentage,
                    installments: rawFormData.installments,
                    monthly: rawFormData.monthly,
                    words: rawFormData.words,
                    
                    // Metadata
                    dateStr: new Date().toISOString().split('T')[0],
                    timestamp: new Date().toISOString(),
                    year: new Date().getFullYear(),
                    month: new Date().getMonth() + 1,
                    day: new Date().getDate(),
                    status: 'Approved'
                };

                // Show loading
                const saveBtn = document.querySelector('#new-entry-tab button');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;

                // Save to Firebase
                const docRef = await window.addDoc(
                    window.collection(window.db, "applications"), 
                    applicationData
                );
                
                console.log("Document written with ID: ", docRef.id);
                
                // Generate Word document using template
                await generateWordDocument(applicationData, docRef.id);
                
                // Reset form
                document.getElementById('entryForm').reset();
                resetCalculatedFields();
                
                // Show success
                alert("✅ Application saved successfully! Word document has been downloaded.");
                
                // Switch to dashboard
                switchTab('dashboard');
                
            } catch(error) {
                console.error("Error saving application: ", error);
                alert("Error: " + error.message);
            } finally {
                // Reset button
                const saveBtn = document.querySelector('#new-entry-tab button');
                if(saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Application & Generate Letter';
                    saveBtn.disabled = false;
                }
            }
        }

        // ===== WORD DOCUMENT GENERATION =====
        // Helper function to load template
        async function loadTemplate() {
            // Replace with your actual GitHub raw URL, e.g., 'https://raw.githubusercontent.com/YOURUSERNAME/YOURREPO/main/template.docx'
            const templateUrl = 'https://github.com/spuwelfarediary-cloud/welfare-das/blob/main/public/template.docx'; // Change to raw URL for production, e.g., 'https://raw.githubusercontent.com/yourusername/yourrepo/main/template.docx'
            
            try {
                console.log(`Trying to load template from: ${templateUrl}`);
                const response = await fetch(templateUrl);
                
                if (response.ok) {
                    const templateFile = await response.arrayBuffer();
                    console.log('✅ Template loaded successfully');
                    return templateFile;
                } else {
                    throw new Error('Template not found: ' + response.status);
                }
            } catch (err) {
                console.error('Error loading template: ', err);
                throw err;
            }
        }

        async function generateWordDocument(application, docId) {
            try {
                console.log("Generating Word document...");
                
                // Load template
                const templateFile = await loadTemplate();
                
                // Initialize PizZip with the template
                const zip = new PizZip(templateFile);
                
                // Initialize docxtemplater with custom delimiters for {{ }}
                const doc = new docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                    delimiters: {
                        start: '{{',
                        end: '}}'
                    }
                });
                
                // Prepare data for template
                const [year, month, day] = application.dateStr.split('-');
                const templateData = {
                    ApplicantName: application.name,
                    Rank: application.rank,
                    BeltNo: application.belt,
                    CNIC: application.cnic,
                    AccountNo: application.account,
                    TotalBalance: Number(application.balance).toLocaleString(),
                    AdvanceAmount: Number(application.advance).toLocaleString(),
                    AmountWords: application.words,
                    MonthlyInstallment: Number(application.monthly).toLocaleString(),
                    Installments: application.installments,
                    Percentage: application.percentage,
                    day: day,
                    month: month,
                    year: year
                };
                
                console.log("Template data prepared:", templateData);
                
                // Set the template variables
                doc.setData(templateData);
                
                // Render the document
                doc.render();
                
                // Generate the output
                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });
                
                // Create filename
                const filename = `GP_Advance_${application.name.replace(/\s+/g, '_')}_${application.dateStr}.docx`;
                
                // Save the file
                saveAs(out, filename);
                
                console.log(`✅ Word document generated: ${filename}`);
                return true;
                
            } catch (error) {
                console.error("❌ Error generating Word document:", error);
                
                // Fallback to simple text document
                console.log("Using fallback text document...");
                generateFallbackDocument(application, docId);
                return false;
            }
        }

        async function generateBatchWord() {
            const date = document.getElementById('report-date').value;
            if(!date) {
                alert("Please select a date");
                return;
            }
            
            const filtered = allApplications.filter(app => app.dateStr === date);
            
            if(filtered.length === 0) {
                alert("No applications found for selected date");
                return;
            }
            
            try {
                console.log(`Generating batch document for ${filtered.length} applications...`);
                
                // Load template
                const templateFile = await loadTemplate();
                
                // Initialize PizZip with the template
                const zip = new PizZip(templateFile);
                
                // Initialize docxtemplater with custom delimiters
                const doc = new docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                    delimiters: {
                        start: '{{',
                        end: '}}'
                    }
                });
                
                // Prepare data array for loop
                const templateData = {
                    req: filtered.map(app => {
                        const [year, month, day] = app.dateStr.split('-');
                        return {
                            ApplicantName: app.name,
                            Rank: app.rank,
                            BeltNo: app.belt,
                            CNIC: app.cnic,
                            AccountNo: app.account,
                            TotalBalance: Number(app.balance).toLocaleString(),
                            AdvanceAmount: Number(app.advance).toLocaleString(),
                            AmountWords: app.words,
                            MonthlyInstallment: Number(app.monthly).toLocaleString(),
                            Installments: app.installments,
                            Percentage: app.percentage,
                            day: day,
                            month: month,
                            year: year
                        };
                    })
                };
                
                console.log(`Batch data prepared for ${filtered.length} applications`);
                
                // Set the template variables
                doc.setData(templateData);
                
                // Render the document
                doc.render();
                
                // Generate the output
                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });
                
                // Create filename
                const filename = `GP_Advance_Batch_${date}_(${filtered.length}_Letters).docx`;
                
                // Save the file
                saveAs(out, filename);
                
                console.log(`✅ Batch Word document generated: ${filename}`);
                
            } catch (error) {
                console.error("❌ Error generating batch Word document:", error);
                
                // Fallback to simple batch document
                console.log("Using fallback batch text document...");
                generateFallbackBatchDocument(filtered, date);
            }
        }

        // Fallback function if template not found
        function generateFallbackDocument(application, docId) {
            const [year, month, day] = application.dateStr.split('-');
            const letterContent = `
Government of the Punjab
Police Department

No.                       ${settings.letterPrefix}                     	             Dated ${day} / ${month} / ${year}
ORDER:
In exercise of the powers vested in me under Rule.1.14(1)(a)(iv)(d)(i) of the Punjab Provident Fund Rules, 1978, sanction is hereby accorded to the grant of refundable advance of Rs.${application.advance}/- (Rupees ${application.words}) in respect of Mr. ${application.name} ${application.rank} ${application.belt} of Special Protection Unit (SPU) Punjab Lahore from his G.P. Fund Account as mentioned in his G.P. Fund/Personal Account No. ${application.account} and CNIC No. ${application.cnic} For construction/repairing of his house.

The amount is approximately equal to ${application.percentage}% of the balance at his credit in his G.P. Fund account Rs. ${application.balance}/-.

2. The recovery of the advance shall be made at the rate of Rs. ${application.monthly}/- in ${application.installments} equal installments from the pay of subscriber which will commence from the pay of the month following the month in which the advance is drawn.

3. It is certified that there is sufficient balance at his credit to meet the advance. The amount of advance is debatable under head G-Liabilities-G06-Trust Account Fund-G061-Provident Fund-G06103-General Provident Fund (Civil)-LO5635.

Additional Director Admin/DDO,
for Director/Deputy Inspector General of Police,
Special Protection Unit,
Punjab, Lahore.

No. /Acct/SPU Dated /${year}

A copy is forwarded for information and necessary action to the:-

I. Accountant General, Punjab, Lahore.

Additional Director Admin/DDO,
for Director/Deputy Inspector General of Police,
Special Protection Unit,
Punjab, Lahore.
            `.trim();
            
            const blob = new Blob([letterContent], { type: 'text/plain' });
            const filename = `GP_Advance_${application.name.replace(/\s+/g, '_')}_${application.dateStr}.txt`;
            saveAs(blob, filename);
            console.log(`Fallback text document generated: ${filename}`);
        }

        function generateFallbackBatchDocument(filtered, date) {
            let combinedContent = '';
            filtered.forEach((app, index) => {
                const [year, month, day] = app.dateStr.split('-');
                combinedContent += `LETTER ${index + 1}\n`;
                combinedContent += `Date: ${app.dateStr}\n\n`;
                
                combinedContent += `
Government of the Punjab
Police Department

No.                       ${settings.letterPrefix}                     	             Dated ${day} / ${month} / ${year}
ORDER:
In exercise of the powers vested in me under Rule.1.14(1)(a)(iv)(d)(i) of the Punjab Provident Fund Rules, 1978, sanction is hereby accorded to the grant of refundable advance of Rs.${app.advance}/- (Rupees ${app.words}) in respect of Mr. ${app.name} ${app.rank} ${app.belt} of Special Protection Unit (SPU) Punjab Lahore from his G.P. Fund Account as mentioned in his G.P. Fund/Personal Account No. ${app.account} and CNIC No. ${app.cnic} For construction/repairing of his house.

The amount is approximately equal to ${app.percentage}% of the balance at his credit in his G.P. Fund account Rs. ${app.balance}/-.

2. The recovery of the advance shall be made at the rate of Rs. ${app.monthly}/- in ${app.installments} equal installments from the pay of subscriber which will commence from the pay of the month following the month in which the advance is drawn.

3. It is certified that there is sufficient balance at his credit to meet the advance. The amount of advance is debatable under head G-Liabilities-G06-Trust Account Fund-G061-Provident Fund-G06103-General Provident Fund (Civil)-LO5635.

Additional Director Admin/DDO,
for Director/Deputy Inspector General of Police,
Special Protection Unit,
Punjab, Lahore.

No. /Acct/SPU Dated /${year}

A copy is forwarded for information and necessary action to the:-

I. Accountant General, Punjab, Lahore.

Additional Director Admin/DDO,
for Director/Deputy Inspector General of Police,
Special Protection Unit,
Punjab, Lahore.
                `.trim();
                
                combinedContent += '\n\n' + '='.repeat(80) + '\n\n';
            });
            
            const blob = new Blob([combinedContent], { type: 'text/plain' });
            const filename = `GP_Advance_Batch_${date}_(${filtered.length}_Letters).txt`;
            saveAs(blob, filename);
            console.log(`Fallback batch text document generated: ${filename}`);
        }

        // ===== EXCEL EXPORT =====
        function generateBatchExcel() {
            const date = document.getElementById('report-date').value;
            const filtered = allApplications.filter(app => app.dateStr === date);
            
            if(filtered.length === 0) {
                alert("No applications found for selected date");
                return;
            }
            
            exportExcel(filtered, `Daily_Report_${date}`);
        }

        function exportMasterExcel() {
            exportExcel(allApplications, "Master_Database");
        }

        function exportExcel(data, name) {
            const wsData = data.map(item => ({
                'Date': item.dateStr,
                'Name': item.name,
                'Rank': item.rank,
                'Belt No': item.belt,
                'CNIC': item.cnic,
                'GP Account': item.account,
                'GP Balance': item.balance,
                'Advance Amount': item.advance,
                'Percentage': item.percentage,
                'Installments': item.installments,
                'Monthly Deduction': item.monthly,
                'Amount in Words': item.words,
                'Status': item.status || 'Approved'
            }));
            
            const ws = XLSX.utils.json_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Applications");
            XLSX.writeFile(wb, name + ".xlsx");
        }

        // ===== UPDATE FUNCTIONS =====
        function updateDashboard() {
            const todayStr = new Date().toISOString().split('T')[0];
            const todayApps = allApplications.filter(app => app.dateStr === todayStr);
            const totalAmount = allApplications.reduce((acc, curr) => acc + (curr.advance || 0), 0);
            
            document.getElementById('total-count').textContent = allApplications.length;
            document.getElementById('today-count').textContent = todayApps.length;
            document.getElementById('total-amount').textContent = (totalAmount / 1000000).toFixed(2) + " M";
        }

        function updateRecentTable() {
            const tbody = document.getElementById('recent-table');
            const recentApps = allApplications.slice(0, 10);
            
            tbody.innerHTML = recentApps.map(app => `
                <tr>
                    <td>${app.dateStr}</td>
                    <td>${app.name}</td>
                    <td>${app.rank}</td>
                    <td>₹${app.advance?.toLocaleString() || '0'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadSingleLetter('${app.id}')">
                            <i class="fas fa-download"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateMasterTable() {
            const tbody = document.getElementById('master-table');
            
            tbody.innerHTML = allApplications.map(app => `
                <tr>
                    <td>${app.dateStr}</td>
                    <td>${app.name}</td>
                    <td>${app.rank}</td>
                    <td>${app.belt}</td>
                    <td>₹${app.advance?.toLocaleString() || '0'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="downloadSingleLetter('${app.id}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteApplication('${app.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateReportPreview() {
            const date = document.getElementById('report-date').value;
            const filtered = allApplications.filter(app => app.dateStr === date);
            const previewDiv = document.getElementById('date-list');
            
            if(filtered.length === 0) {
                previewDiv.innerHTML = `<p class="text-muted">No applications found for ${date}</p>`;
            } else {
                let html = `<p>Found ${filtered.length} applications for ${date}:</p>`;
                html += '<ul class="list-group">';
                filtered.forEach(app => {
                    html += `
                        <li class="list-group-item">
                            <strong>${app.name}</strong> - ${app.rank} 
                            (Belt: ${app.belt}) - ₹${app.advance?.toLocaleString()}
                        </li>
                    `;
                });
                html += '</ul>';
                previewDiv.innerHTML = html;
            }
        }

        // ===== UTILITY FUNCTIONS =====
        async function downloadSingleLetter(id) {
            const app = allApplications.find(a => a.id === id);
            if(app) {
                await generateWordDocument(app, id);
            }
        }

        async function deleteApplication(id) {
            if(!confirm('Are you sure you want to delete this application?')) {
                return;
            }
            
            try {
                await window.deleteDoc(window.doc(window.db, "applications", id));
                alert('Application deleted successfully');
            } catch(error) {
                console.error("Error deleting application: ", error);
                alert("Error deleting application: " + error.message);
            }
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('gpAdvanceSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                
                // Update form fields
                document.getElementById('max-percentage').value = settings.maxPercentage;
                document.getElementById('percentage-value').textContent = settings.maxPercentage + '%';
                document.getElementById('default-installments').value = settings.installments;
                document.getElementById('letter-prefix').value = settings.letterPrefix;
            }
        }

        function saveSettings() {
            settings.maxPercentage = parseInt(document.getElementById('max-percentage').value);
            settings.installments = parseInt(document.getElementById('default-installments').value);
            settings.letterPrefix = document.getElementById('letter-prefix').value.trim();
            
            localStorage.setItem('gpAdvanceSettings', JSON.stringify(settings));
            alert('Settings saved successfully!');
        }

        // Update report preview when date changes
        document.getElementById('report-date').addEventListener('change', updateReportPreview);

        // Make functions available globally
        window.switchTab = switchTab;
        window.toggleSidebar = toggleSidebar;
        window.calculateDetails = calculateDetails;
        window.saveApplication = saveApplication;
        window.generateBatchWord = generateBatchWord;
        window.generateBatchExcel = generateBatchExcel;
        window.exportMasterExcel = exportMasterExcel;
        window.downloadSingleLetter = downloadSingleLetter;
        window.deleteApplication = deleteApplication;
        window.saveSettings = saveSettings;

        // Initialize
        console.log("GP Fund System initialized");
    </script>
</body>
</html>
